name: Deploy to Staging

on:
  push:
    branches: [develop]
  workflow_dispatch:

permissions:
  contents: read
  deployments: write

jobs:
  deploy:
    name: Deploy to Staging Environment
    runs-on: ubuntu-latest
    env:
      HAS_STAGING_CONFIG: ${{ secrets.STAGING_SSH_KEY != '' && secrets.STAGING_HOST != '' && secrets.STAGING_USER != '' }}
      HAS_SLACK: ${{ secrets.SLACK_WEBHOOK != '' }}
    environment:
      name: staging
      url: https://staging.coffeestudio.example.com
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Create Deployment
        id: deployment
        uses: chrnorm/deployment-action@v2
        with:
          token: ${{ github.token }}
          environment: staging
          description: 'Deploying ${{ github.sha }} to staging'
      
      - name: Configure SSH
        if: env.HAS_STAGING_CONFIG == 'true'
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.STAGING_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.STAGING_HOST }} >> ~/.ssh/known_hosts
      
      - name: Deploy via SSH
        if: env.HAS_STAGING_CONFIG == 'true'
        run: |
          ssh ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }} << 'EOF'
            set -e
            cd /opt/coffeestudio
            echo "Pulling latest code from develop branch..."
            git pull origin develop
            echo "Pulling latest Docker images..."
            docker compose -f docker-compose.staging.yml pull
            echo "Starting services..."
            docker compose -f docker-compose.staging.yml up -d
            echo "Running database migrations..."
            docker compose -f docker-compose.staging.yml exec -T backend alembic upgrade head
            echo "Deployment complete!"
          EOF
      
      - name: Deploy (No SSH - Placeholder)
        if: env.HAS_STAGING_CONFIG != 'true'
        run: |
          echo "âš ï¸ STAGING_SSH_KEY not configured"
          echo "This is a placeholder deployment step"
          echo "To enable actual deployment, configure these secrets:"
          echo "  - STAGING_SSH_KEY: SSH private key for staging server"
          echo "  - STAGING_HOST: Staging server hostname"
          echo "  - STAGING_USER: SSH user for staging server"
          echo ""
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
      
      - name: Wait for Deployment
        run: sleep 30
      
      - name: Health Check
        id: health_check
        run: |
          if [ -n "${{ secrets.STAGING_HOST }}" ]; then
            echo "Running health check on staging server..."
            for i in {1..10}; do
              if curl -f https://staging.coffeestudio.example.com/health; then
                echo "Health check passed"
                exit 0
              fi
              echo "Attempt $i failed, retrying..."
              sleep 10
            done
            exit 1
          else
            echo "Skipping health check (no staging server configured)"
          fi
        continue-on-error: true
      
      - name: Run Smoke Tests
        if: env.HAS_STAGING_CONFIG == 'true'
        run: |
          echo "Running smoke tests..."
          curl -f https://staging.coffeestudio.example.com/health || echo "âš ï¸ Health endpoint not accessible"
          curl -f https://staging.coffeestudio.example.com/docs || echo "âš ï¸ Docs endpoint not accessible"
        continue-on-error: true
      
      - name: Update Deployment Status (Success)
        if: success()
        uses: chrnorm/deployment-status@v2
        with:
          token: ${{ github.token }}
          deployment-id: ${{ steps.deployment.outputs.deployment_id }}
          state: 'success'
          environment-url: https://staging.coffeestudio.example.com
      
      - name: Update Deployment Status (Failure)
        if: failure()
        uses: chrnorm/deployment-status@v2
        with:
          token: ${{ github.token }}
          deployment-id: ${{ steps.deployment.outputs.deployment_id }}
          state: 'failure'
      
      - name: Notify Slack
        if: always() && env.HAS_SLACK == 'true'
        uses: slackapi/slack-github-action@v1
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK }}
          payload: |
            {
              "text": "Staging Deployment: ${{ job.status }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "ðŸš€ Staging deployment *${{ job.status }}*\nCommit: `${{ github.sha }}`\nBranch: `${{ github.ref_name }}`\nActor: ${{ github.actor }}"
                  }
                }
              ]
            }
        continue-on-error: true
      
      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸš€ Deployed to staging: https://staging.coffeestudio.example.com\nCommit: ${{ github.sha }}'
            })
        continue-on-error: true
