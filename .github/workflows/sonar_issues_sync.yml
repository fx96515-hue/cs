name: Sync SonarCloud Issues -> GitHub Issues

on:
  workflow_dispatch:
  schedule:
    - cron: "30 5 * * *"  # daily 05:30 UTC

permissions:
  contents: read
  issues: write

concurrency:
  group: sonar-issues-sync
  cancel-in-progress: false

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      
      - name: Install dependencies
        run: pip install httpx

      - name: Run Sonar -> GitHub Issues sync
        env:
          SONAR_API_BASE: https://sonarcloud.io/api
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_PROJECT_KEY: ${{ vars.SONAR_PROJECT_KEY }}
          SONAR_BRANCH: ${{ vars.SONAR_BRANCH }}
          SONAR_SEVERITIES: ${{ vars.SONAR_SEVERITIES }}
          SONAR_STATUSES: ${{ vars.SONAR_STATUSES }}
          SONAR_MAX_CREATE: ${{ vars.SONAR_MAX_CREATE }}
          SONAR_LABEL: ${{ vars.SONAR_LABEL }}
          SONAR_AUTO_CLOSE: ${{ vars.SONAR_AUTO_CLOSE }}
          GITHUB_TOKEN: ${{ github.token }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: python scripts/automation/sonar_sync_issues.py
