name: Frontend CI

on:
  push:
    branches: [main, develop]
    paths:
      - 'apps/web/**'
      - '.github/workflows/ci-frontend.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'apps/web/**'
  workflow_call:  # Allow this workflow to be called by other workflows

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  lint-and-type-check:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: apps/web/package-lock.json
      
      - name: Install dependencies
        run: |
          cd apps/web
          npm ci
      
      - name: Run ESLint
        run: |
          cd apps/web
          npm run lint
      
      - name: Run TypeScript Type Check
        run: |
          cd apps/web
          npx tsc --noEmit

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: apps/web/package-lock.json
      
      - name: Install dependencies
        run: |
          cd apps/web
          npm ci
      
      - name: Run Tests
        run: |
          cd apps/web
          npm test -- --coverage --passWithNoTests || echo "No tests found, continuing..."
        continue-on-error: true
      
      - name: Upload Coverage
        if: hashFiles('apps/web/coverage/**') != ''
        uses: codecov/codecov-action@v4
        with:
          directory: ./apps/web/coverage
          flags: frontend
          name: frontend-coverage
          token: ${{ secrets.CODECOV_TOKEN }}
        continue-on-error: true

  build:
    name: Production Build
    runs-on: ubuntu-latest
    needs: [lint-and-type-check, test]
    permissions:
      contents: read
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: apps/web/package-lock.json
      
      - name: Install dependencies
        run: |
          cd apps/web
          npm ci
      
      - name: Build Application
        env:
          NEXT_PUBLIC_API_URL: https://api.staging.coffeestudio.example.com
        run: |
          cd apps/web
          npm run build
      
      - name: Check Build Output
        run: |
          cd apps/web
          ls -lah .next/ || true
          du -sh .next/ || true
      
      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: apps/web/.next/
          retention-days: 7

  e2e-tests:
    name: E2E Tests (Docker Stack)
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: read
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Create .env file for testing
        run: |
          DB_PASSWORD="$(openssl rand -hex 16)"
          BOOTSTRAP_PASSWORD="$(openssl rand -hex 16)"
          cat > .env << EOF
          APP_ENV=test
          POSTGRES_PASSWORD=${DB_PASSWORD}
          DATABASE_URL=postgresql+psycopg://coffeestudio:${DB_PASSWORD}@postgres:5432/coffeestudio
          REDIS_URL=redis://redis:6379/0
          JWT_SECRET=test_secret_key_for_e2e_tests_minimum_32_characters_long
          JWT_ISSUER=coffeestudio
          JWT_AUDIENCE=coffeestudio-users
          BOOTSTRAP_ADMIN_EMAIL=admin@coffeestudio.com
          BOOTSTRAP_ADMIN_PASSWORD=${BOOTSTRAP_PASSWORD}
          NEXT_PUBLIC_API_URL=http://localhost:8000
          EOF
      
      - name: Start Docker Stack
        run: |
          docker compose up -d --build
          sleep 30
      
      - name: Wait for Backend
        run: |
          timeout 120 bash -c 'until curl -f http://localhost:8000/health; do sleep 5; done'
      
      - name: Wait for Frontend
        run: |
          timeout 120 bash -c 'until curl -f http://localhost:3000; do sleep 5; done'
      
      - name: Bootstrap Admin User
        run: |
          curl -f -X POST http://localhost:8000/auth/dev/bootstrap || echo "Bootstrap may have already run"
        continue-on-error: true
      
      - name: Basic Smoke Tests
        run: |
          echo "Testing backend health..."
          curl -f http://localhost:8000/health
          echo "Testing frontend..."
          curl -f http://localhost:3000
          echo "Testing API docs..."
          curl -f http://localhost:8000/docs
      
      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== Backend Logs ==="
          docker compose logs backend --tail=100
          echo "=== Frontend Logs ==="
          docker compose logs frontend --tail=100
          echo "=== PostgreSQL Logs ==="
          docker compose logs postgres --tail=50
      
      - name: Cleanup
        if: always()
        run: |
          docker compose down -v
